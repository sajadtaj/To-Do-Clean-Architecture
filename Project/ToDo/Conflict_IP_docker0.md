## 🧾 **مستند شناسایی و رفع کانفلیکت IP در Docker**

---

### 🟡 **تعریف مشکل**

در یکی از سرورهای لینوکسی درون شبکه شرکت، پس از اجرای یک سرویس با Docker Compose، مشاهده شد که این سرویس از **درون شبکه PAM** قابل مشاهده است اما **از داخل شرکت (LAN)** قابل دسترسی نیست. در حالی که:

* پورت سرویس به‌درستی با `-p 4834:80` منتشر شده بود.
* فایروال `ufw` به‌درستی پورت 4834 را باز کرده بود.
* سرویس با موفقیت اجرا شده و کانتینر فعال بود.

---

### 🔍 **مرحله ۱: بررسی رابط‌های شبکه (Network Interfaces)**

دستور زیر اجرا شد:

```bash
ip a
```

خروجی:

```bash
3: docker0: <NO-CARRIER,...> state DOWN
    inet 172.17.0.1/16
```

در همین حال، مشخص شد که **شبکه داخلی شرکت نیز از همین رنج `172.17.0.0/16` استفاده می‌کند**. بنابراین رنج IP پل Docker (`docker0`) با شبکه شرکت **کانفلیکت (Conflict)** داشت.

---

### 🔥 **اثرات مشکل:**

* شبکه شرکت نمی‌تواند پکت‌ها را به درستی route کند چون IP مقصد تداخلی است.
* Docker به علت کانفلیکت routing نتوانسته پل را فعال کند (`state DOWN`).
* کانتینر در حال اجراست ولی از بیرون شبکه در دسترس نیست.

---

### 🧠 **مرحله ۲: تحلیل راه‌حل‌های ممکن**

| راه‌حل                                       | مزایا                     | معایب                           |
| -------------------------------------------- | ------------------------- | ------------------------------- |
| تغییر IP Bridge داکر (`bip`)                 | ساده، موثر، سریع          | نیاز به restart Docker          |
| استفاده از `host` network                    | ساده و بدون NAT           | باعث از دست رفتن ایزولیشن       |
| تعریف شبکه سفارشی با `docker network create` | قابل کنترل برای چند پروژه | پیچیدگی در تنظیمات اولیه        |
| اعمال NAT یا static route در روتر شرکت       | بدون تغییر به داکر        | وابسته به تیم شبکه و امنیت شرکت |

---

### ✅ **راه‌حل انتخاب‌شده: تغییر `docker0` به `192.168.147.0/24`**

---

### 🛠️ **مرحله ۳: اجرای تغییر IP Bridge در Docker**

#### 1. ساخت یا ویرایش فایل `/etc/docker/daemon.json`:

```bash
sudo nano /etc/docker/daemon.json
```

محتوای فایل:

```json
{
  "bip": "192.168.147.1/24"
}
```

> مقدار `bip` = Bridge IP که باعث می‌شود Docker شبکه‌ای با subnet جدید بسازد.

---

#### 2. حذف دستی پل فعلی `docker0` (در صورت وجود):

```bash
sudo ip link set docker0 down
sudo ip link delete docker0
```

---

#### 3. ریستارت Docker:

```bash
sudo systemctl restart docker
```

---

#### 4. بررسی صحت تغییر:

```bash
ip a | grep docker0 -A 3
```

باید خروجی مانند زیر باشد:

```
3: docker0: ...
    inet 192.168.147.1/24 scope global docker0
```

---

### 🧪 **تست نهایی دسترسی:**

از داخل شرکت:

```bash
curl http://<IP-SERVER>:4834
```

---

### 📌 **نکات DevOps و امنیتی**

* توصیه می‌شود این تغییر در سیستم‌های چندسروری از طریق **Ansible role** مدیریت شود.
* هر پروژه‌ای که از `docker-compose` استفاده می‌کند، به‌صورت پیش‌فرض از همین `bridge` استفاده خواهد کرد مگر شبکه سفارشی تعریف شود.
* دقت شود که `192.168.147.0/24` نباید در شبکه واقعی دیگری هم استفاده شده باشد.

---

### ✅ جمع‌بندی نهایی

| گام                              | توضیح                                                    |
| -------------------------------- | -------------------------------------------------------- |
| مشاهده عدم دسترسی به سرویس       | فقط از PAM قابل دسترسی بود                               |
| بررسی پورت و فایروال             | همه صحیح بودند                                           |
| بررسی `ip a` و تشخیص IP Conflict | docker0 در `172.17.0.1/16` بود که با LAN شرکت تداخل داشت |
| تغییر به `192.168.147.0/24`      | از طریق `daemon.json`                                    |
| تست نهایی موفقیت‌آمیز            | دسترسی از LAN شرکت برقرار شد                             |

---

